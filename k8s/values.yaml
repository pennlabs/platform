deploy_version: 0.1.20
image_tag: latest

applications:
  - name: django
    image: pennlabs/platform-backend
    secret: platform
    port: 443
    ingress:
      hosts:
        - host: platform.pennlabs.org
          paths:
            [
              "/admin",
              "/accounts",
              "/assets",
              "/identity",
              "/s",
              "/options",
              "/openapi",
              "/documentation",
              "/Shibboleth.sso",
            ]
      annotations:
        ingress.kubernetes.io/protocol: http
    extraEnv:
      - name: DOMAIN
        value: platform.pennlabs.org
      - name: DJANGO_SETTINGS_MODULE
        value: Platform.settings.production
    secretMounts:
      - name: platform
        item: SHIBBOLETH_CERT
        path: "/etc/shibboleth/sp-cert.pem"
      - name: platform
        item: SHIBBOLETH_KEY
        path: "/etc/shibboleth/sp-key.pem"
  - name: react
    image: pennlabs/platform-frontend
    replicas: 2
    ingress:
      hosts:
        - host: platform.pennlabs.org
          paths: ["/"]
    extraEnv:
      - name: PORT
        value: 80
      - name: DOMAIN
        value: platform.pennlabs.org
  - name: dev
    image: pennlabs/platform-dev
    secret: platform-dev
    port: 8080
    ingress:
      hosts:
        - host: platform-dev.pennlabs.org
          paths: ["/"]
    extraEnv:
      - name: DOMAIN
        value: platform-dev.pennlabs.org
      - name: DJANGO_SETTINGS_MODULE
        value: Platform.settings.production
      - name: DEV_LOGIN
        value: True

cronjobs:
  - name: clear-expired-tokens
    schedule: "0 5 * * 0"
    image: pennlabs/platform-backend
    secret: platform
    cmd: ["python3", "manage.py", "cleartokens"]
